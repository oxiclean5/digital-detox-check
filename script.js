// ì–¸ì–´ë³„ ì§ˆë¬¸ ìë™ í• ë‹¹

const results_ko = {
    safe: {
        title: "âœ¨ ë””ì§€í„¸ ì²­ì • êµ¬ì—­ì˜ ì§€ë°°ì âœ¨",
        description: "ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ìŠ¤ë§ˆíŠ¸í°ì˜ ì£¼ì¸ì´ì ë””ì§€í„¸ ì„¸ìƒì˜ ëª¨ë²” ì‹œë¯¼ì…ë‹ˆë‹¤. ê°€ë” ë¡œê·¸ì•„ì›ƒí•´ë„ ë¶ˆì•ˆí•˜ì§€ ì•Šì€ ë‹¹ì‹ , ì§„ì •í•œ ê³ ìˆ˜ì‹œë„¤ìš”.",
        solutions: [
            "<strong>ì£¼ 1íšŒ 'ë””ì§€í„¸ ê¸ˆì‹'ì˜ ë‚  ì‹¤ì²œí•˜ê¸°:</strong> ì €ë… ì‹œê°„ ë§Œì´ë¼ë„ ì˜ë„ì ìœ¼ë¡œ í°ì„ ë©€ë¦¬í•˜ê³  ì±…ì´ë‚˜ ìŒì•…ê³¼ í•¨ê»˜ í•´ë³´ì„¸ìš”.",
            "<strong>ìƒˆë¡œìš´ ì˜¤í”„ë¼ì¸ ì·¨ë¯¸ íƒìƒ‰í•˜ê¸°:</strong> ë‹¹ì‹ ì˜ ê· í˜•ê°ê°ì„ ë”ìš± ë¹›ë‚´ì¤„ ìƒˆë¡œìš´ í™œë™ì„ ì°¾ì•„ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
            "<strong>ì„ í•œ ì˜í–¥ë ¥ ì „íŒŒí•˜ê¸°:</strong> ì£¼ë³€ì— ìŠ¤ë§ˆíŠ¸í° ë•Œë¬¸ì— í˜ë“¤ì–´í•˜ëŠ” ì¹œêµ¬ê°€ ìˆë‹¤ë©´, ë‹¹ì‹ ì˜ ê¿€íŒì„ ìŠ¬ì© ê³µìœ í•´ì£¼ì„¸ìš”."
        ]
    },
    warning: {
        title: "ğŸ“± ìŠ¤ë§ˆíŠ¸í°ê³¼ ë°€ë‹¹í•˜ëŠ” ì‚¬ì´ ğŸ’”",
        description: "ìŠ¤ë§ˆíŠ¸í°ê³¼ ì• ì¦ì˜ ê´€ê³„ì— ìˆìœ¼ì‹œêµ°ìš”. 'ì ê¹ë§Œ ë´ì•¼ì§€' í•˜ë‹¤ê°€ ìƒˆë²½ 3ì‹œê°€ ë˜ëŠ” ë§ˆë²•, ìì£¼ ê²½í—˜í•˜ì‹œì£ ? ì•„ì§ ëŠ¦ì§€ ì•Šì•˜ì–´ìš”!",
        solutions: [
            "<strong>ì¹¨ì‹¤ì„ 'ìŠ¤ë§ˆíŠ¸í° ì²­ì • êµ¬ì—­'ìœ¼ë¡œ ì„ í¬í•˜ê¸°:</strong> ì¶©ì „ê¸°ëŠ” ì¹¨ì‹¤ ë°–ì— ë‘ê³ , ì•ŒëŒì€ ì €ë ´í•œ ìëª…ì¢… ì‹œê³„ë¥¼ í™œìš©í•´ë³´ì„¸ìš”. íš¨ê³¼ëŠ” ë†€ë¼ìš¸ ê±°ì˜ˆìš”!",
            "<strong>ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ê³¼ê°íˆ ë„ê¸°:</strong> ì‡¼í•‘ ì•±, ê²Œì„ ì•± ë“± ì§€ê¸ˆ ë‹¹ì¥ í™•ì¸í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ì•±ì˜ ì•Œë¦¼ì€ ëª¨ë‘ êº¼ë‘ì„¸ìš”. ë‚´ ì‹œê°„ì˜ ì£¼ì¸ì€ ë‚˜ ìì‹ ì…ë‹ˆë‹¤.",
            "<strong>ì•± ì‚¬ìš© ì‹œê°„ ì œí•œ ì„¤ì •í•˜ê¸°:</strong> ìŠ¤ë§ˆíŠ¸í°ì˜ ìŠ¤í¬ë¦° íƒ€ì„ ê¸°ëŠ¥ì„ ì´ìš©í•´ SNS, ìœ íŠœë¸Œ ë“± íŠ¹ì • ì•±ì— ì‹œê°„ì œí•œì„ ê±¸ì–´ë³´ì„¸ìš”. í°ì´ ì”ì†Œë¦¬í•˜ê²Œ ë§Œë“œì„¸ìš”."
        ]
    },
    danger: {
        title: "ğŸ˜µ ìŠ¤ë§ˆíŠ¸í°ê³¼ ê±°ì˜ í•œ ëª¸ ğŸ˜µ",
        description: "í˜¹ì‹œ... ìŠ¤ë§ˆíŠ¸í°ì´ ì†ì—ì„œ ìë¼ë‚˜ê³  ìˆë‚˜ìš”? ëˆˆì„ ëœ¨ìë§ˆì, ì‹¬ì§€ì–´ í™”ì¥ì‹¤ì—ì„œë„ í•¨ê»˜í•˜ëŠ” ë‹¹ì‹ ì€ 'í”„ë¡œ ìŠ¤ë§ˆíŠ¸í°ëŸ¬'!",
        solutions: [
            "<strong>'ë°©í•´ê¸ˆì§€ ëª¨ë“œ' ì ê·¹ í™œìš©í•˜ê¸°:</strong> ì—…ë¬´, ê³µë¶€, ìˆ˜ë©´ ì‹œê°„ì—ëŠ” ë°©í•´ê¸ˆì§€ ëª¨ë“œë¥¼ ì˜ˆì•½ ì„¤ì •í•˜ì—¬ ìŠ¤ë§ˆíŠ¸í°ì˜ ìœ í˜¹ì„ ì›ì²œ ì°¨ë‹¨í•˜ì„¸ìš”.",
            "<strong>ë¬¼ë¦¬ì  'í° ì—†ëŠ” ê³µê°„' ë§Œë“¤ê¸°:</strong> ì‹íƒ, ì¹¨ëŒ€ ìœ„ ë“± íŠ¹ì • ê³µê°„ì„ 'í° í”„ë¦¬ì¡´'ìœ¼ë¡œ ì •í•˜ê³  ê°€ì¡±, ë£¸ë©”ì´íŠ¸ì™€ í•¨ê»˜ ê·œì¹™ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.",
            "<strong>ì˜ë¯¸ ìˆëŠ” ëŒ€ì²´ í™œë™ ê³„íší•˜ê¸°:</strong> í°ì„ ë‚´ë ¤ë†“ê³  ìƒê¸´ ì‹œê°„ì— ë¬´ì—‡ì„ í• ì§€ ë¯¸ë¦¬ êµ¬ì²´ì ìœ¼ë¡œ ì •í•´ë‘ì„¸ìš”. (ì˜ˆ: 10ë¶„ ì‚°ì±…, ì±… 5í˜ì´ì§€ ì½ê¸° ë“±)"
        ]
    }
};

// result.htmlì—ì„œ ê²°ê³¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì „ì—­ í•¨ìˆ˜
window.getResultsData = function(lang) {
    return results_ko;
};

// result.htmlì˜ Kakao.Share.sendDefaultì—ì„œ ì‚¬ìš©í•  ë°ì´í„° (langì— ë”°ë¼ ë³€ê²½)
window.getShareData = function(resultData, lang) {
    const shareTitle = `[ë””ì§€í„¸ ë””í†¡ìŠ¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼] ${resultData.title}`;
    const shareDescription = resultData.description;
    const testLinkTitle = 'ë‚˜ë„ í…ŒìŠ¤íŠ¸í•˜ê¸°';

    return {
        title: shareTitle,
        description: shareDescription,
        testLinkTitle: testLinkTitle
    };
};

document.addEventListener('DOMContentLoaded', () => {
    // index.html í˜ì´ì§€ ë¡œì§
    if (
        window.location.pathname.includes('index.html') ||
        window.location.pathname.includes('index-en.html') ||
        window.location.pathname.includes('index-ja.html') ||
        window.location.pathname === '/'
    ) {
        const startScreen = document.getElementById('start-screen');
        const questionScreen = document.getElementById('question-screen');
        const startBtn = document.getElementById('start-btn');
        
        const questionHeader = document.querySelector('.question-header');
        const questionCounter = document.querySelector('.question-counter');
        const progressBar = document.querySelector('.progress');
        const questionTitle = document.getElementById('question-title');
        const options = document.querySelector('.options');
        const optionBtns = document.querySelectorAll('.option-btn');

        const lang = document.documentElement.lang || 'ko'; // html íƒœê·¸ì˜ lang ì†ì„± ê°€ì ¸ì˜¤ê¸°
        const questions = window[`questions_${lang}`]; // ë™ì ìœ¼ë¡œ ì§ˆë¬¸ ë³€ìˆ˜ ì„ íƒ (ì˜ˆ: window['questions_en'])
        let currentQuestionIndex = 0;
        let score = 0;
        let isProcessing = false; // ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸

        // ì§ˆë¬¸ ë°°ì—´ì´ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (!questions || !Array.isArray(questions) || questions.length === 0) {
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.textContent = "Test not available";
            }
            console.warn("No questions found for this language. Please check the index file's <script> block.");
        } else {
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.addEventListener('click', startTest);
            }
        }

        if (optionBtns && optionBtns.length > 0) {
            optionBtns.forEach(button => {
                button.addEventListener('click', (e) => {
                    if (isProcessing) return;
                    isProcessing = true;

                    // 2. ì„ íƒ í”¼ë“œë°± ê°•í™”
                    const selectedBtn = e.currentTarget;
                    selectedBtn.classList.add('selected');
                    optionBtns.forEach(btn => btn.disabled = true);

                    score += parseInt(button.dataset.score);
                    
                    setTimeout(() => {
                        currentQuestionIndex++;
                        if (currentQuestionIndex < questions.length) {
                            showQuestion();
                        } else {
                            showResult();
                        }
                        // í´ë˜ìŠ¤ ë° ë¹„í™œì„±í™” ìƒíƒœ ì´ˆê¸°í™”
                        selectedBtn.classList.remove('selected');
                        optionBtns.forEach(btn => btn.disabled = false);
                        isProcessing = false;
                    }, 150); // 0.15ì´ˆ ë”œë ˆì´
                });
            });
        }

        function startTest() {
            startScreen.classList.add('hidden');
            questionScreen.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            showQuestion();
        }

        function showQuestion() {
            // 3. ë¶€ë“œëŸ¬ìš´ í™”ë©´ ì „í™˜ íš¨ê³¼ (Fade out)
            questionTitle.style.opacity = 0;
            options.style.opacity = 0;

            setTimeout(() => {
                // 1. ì§ˆë¬¸ ë²ˆí˜¸ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                questionCounter.textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
                const progressPercentage = ((currentQuestionIndex + 1) / questions.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                questionTitle.textContent = questions[currentQuestionIndex];

                // ì˜µì…˜ ë²„íŠ¼ í…ìŠ¤íŠ¸ëŠ” ê° index.html íŒŒì¼ì—ì„œ í•˜ë“œì½”ë”©ëœ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë®ì–´ì“°ì§€ ì•ŠìŒ)

                // 3. ë¶€ë“œëŸ¬ìš´ í™”ë©´ ì „í™˜ íš¨ê³¼ (Fade in)
                questionTitle.style.opacity = 1;
                options.style.opacity = 1;
            }, 100); // 0.1ì´ˆ í›„ ë‚´ìš© ë³€ê²½ ë° fade in
        }

        function showResult() {
            let resultLevel;
            if (score <= 6) {
                resultLevel = 'safe';
            } else if (score <= 13) {
                resultLevel = 'warning';
            } else {
                resultLevel = 'danger';
            }

            // ì–¸ì–´ì— ë”°ë¼ ê²°ê³¼ í˜ì´ì§€ íŒŒì¼ëª… ê²°ì •
            let lang = document.documentElement.lang || 'ko';
            let resultPage = 'result.html';
            if (lang === 'en') {
                resultPage = 'result-en.html';
            } else if (lang === 'ja') {
                resultPage = 'result-ja.html';
            }

            window.location.href = `${resultPage}?level=${resultLevel}&score=${score}`;
        }
    } 
    // result.html í˜ì´ì§€ ë¡œì§
    else if (window.location.pathname.includes('result.html')) {
        const resultScreen = document.getElementById('result-screen');
        const params = new URLSearchParams(window.location.search);
        const level = params.get('level');
        const score = params.get('score');

        // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
        Kakao.init('aa8b0feb153da6756132986b3e91f515');

        // script.jsì—ì„œ ê²°ê³¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const results = window.getResultsData();
        const resultData = results[level] || results['safe'];

        // script.jsì—ì„œ ê³µìœ  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const shareData = window.getShareData(resultData);

        // --- ì‹œê°ì  ìš”ì†Œ ë°ì´í„° ---
        const visualData = {
            safe: {
                icon: 'fa-solid fa-face-smile-beam',
                color: '#2ecc71',
                image: 'img/safe.png'
            },
            warning: {
                icon: 'fa-solid fa-face-meh',
                color: '#f39c12',
                image: 'img/warning.png'
            },
            danger: {
                icon: 'fa-solid fa-face-dizzy',
                color: '#e74c3c',
                image: 'img/danger.png'
            }
        };
        const visual = visualData[level] || visualData['safe'];
        const scorePercentage = (score / 20) * 100; // ìµœëŒ€ ì ìˆ˜ 20ì  ê¸°ì¤€

        let solutionsHtml = '<ul>';
        resultData.solutions.forEach(solution => {
            solutionsHtml += `<li>${solution}</li>`;
        });
        solutionsHtml += '</ul>';

        // í…ìŠ¤íŠ¸
        const scoreText = 'ë‚´ ì ìˆ˜:';
        const howToPractice = 'ì´ë ‡ê²Œ ì‹¤ì²œí•´ë³´ì„¸ìš”!';
        const shareResult = 'ê²°ê³¼ ê³µìœ í•˜ê¸°';
        const kakaoTalk = 'ì¹´ì¹´ì˜¤í†¡';
        const line = 'ë¼ì¸';
        const facebook = 'í˜ì´ìŠ¤ë¶';
        const copyLink = 'ì¸ìŠ¤íƒ€ìš© ë§í¬ ë³µì‚¬';
        const learnMore = 'ë””ì§€í„¸ ë””í†¡ìŠ¤ì— ëŒ€í•´ ë” ì•Œì•„ë³´ê¸° &rarr;';
        const retakeTest = 'í…ŒìŠ¤íŠ¸ ë‹¤ì‹œí•˜ê¸°';

        resultScreen.innerHTML = `
            <i class="result-icon ${visual.icon}" style="color: ${visual.color};"></i>
            <h2>${resultData.title}</h2>
            
            <div class="score-gauge">
                <div class="gauge-bar" style="width: ${scorePercentage}%; background-color: ${visual.color};"></div>
            </div>
            <p id="score-text">${scoreText} ${score}ì </p>
            
            <img src="${visual.image}" alt="${resultData.title}" class="result-image">

            <p>${resultData.description}</p>
            <div class="result-content">
                <h3>${howToPractice}</h3>
                ${solutionsHtml}
            </div>
            <div class="share-buttons">
                <p class="share-title">${shareResult}</p>
                <button id="kakao-share-btn" class="share-btn kakao"><i class="fa-solid fa-comment"></i> ${kakaoTalk}</button>
                <button id="line-share-btn" class="share-btn line"><i class="fa-brands fa-line"></i> ${line}</button>
                <button id="facebook-share-btn" class="share-btn facebook"><i class="fa-brands fa-facebook-f"></i> ${facebook}</button>
                <button id="copy-link-btn" class="share-btn instagram"><i class="fa-brands fa-instagram"></i> ${copyLink}</button>
            </div>
            <div class="info-link-container">
                <a href="article.html" class="info-link">${learnMore}</a>
            </div>
            <button id="restart-btn">${retakeTest}</button>
        `;

        // --- ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.getElementById('kakao-share-btn').addEventListener('click', () => {
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: shareData.title,
                    description: shareData.description,
                    imageUrl: 'img/share_thumbnail.png', // ëŒ€í‘œ ì´ë¯¸ì§€
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
                buttons: [
                    {
                        title: shareData.testLinkTitle,
                        link: {
                            mobileWebUrl: `https://your-website-url.com`, // ë°°í¬ í›„ ì‹¤ì œ ì£¼ì†Œë¡œ ë³€ê²½
                            webUrl: `https://your-website-url.com`, // ë°°í¬ í›„ ì‹¤ì œ ì£¼ì†Œë¡œ ë³€ê²½
                        },
                    },
                ],
            });
        });

        document.getElementById('facebook-share-btn').addEventListener('click', () => {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
        });

        document.getElementById('line-share-btn').addEventListener('click', () => {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(shareData.title);
            window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
        });

        document.getElementById('copy-link-btn').addEventListener('click', (e) => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const copiedText = 'ë³µì‚¬ ì™„ë£Œ!';
                e.target.textContent = copiedText;
                setTimeout(() => {
                    e.target.textContent = copyLink;
                }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                const failText = 'ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”.';
                alert(failText);
            });
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            window.location.href = `index.html`;
        });
    }
});